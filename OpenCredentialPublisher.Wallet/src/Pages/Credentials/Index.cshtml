@page "{handler?}"
@using OpenCredentialPublisher.Wallet.Extensions;
@model OpenCredentialPublisher.ClrWallet.Pages.Clrs.IndexModel
@{
    ViewData["Title"] = "CLRs";

    string PackageType(PackageTypeEnum packageType) =>
        packageType switch
        {
            PackageTypeEnum.Clr => "CLR",
            PackageTypeEnum.ClrSet => "CLRSet",
            PackageTypeEnum.VerifiableCredential => "VerifiableCredential"
        };

}


@*
    <link rel="stylesheet" href="~/lib/font-awesome/css/fontawesome.css" />
    <link rel="stylesheet" href="~/lib/font-awesome/css/solid.css" />
    <link rel="stylesheet" href="~/lib/font-awesome/css/brands.css" />
*@

<div class="row align-items-lg-end mt-5">
    <div class="col">
        <div class="profile-container">

            <div class="profile-picture-container">
                <div class="profile-picture-circle">

                </div>
            </div>

            <div class="profile-body">
                <div class="pencil-container"><a asp-page="/Account/Manage/Index"><span class="pencil-icon"></span></a></div>
                <div class="profile-name text-wrap">@User.Identity.Name</div>
                <div class="row row-cols-2">
                    <div class="col profile-stats stats-border">@Model.Profile.Achievements</div>
                    <div class="col profile-stats">@Model.Profile.Credentials</div>
                    <div class="col stats-label stats-border">ACHIEVEMENTS</div>
                    <div class="col stats-label">
                        CREDENTIALS
                    </div>
                </div>
                <div class="row row-cols-1 mt-3">
                    <div class="col profile-stats">@Model.Profile.ActiveLinks</div>
                    <div class="col stats-label">
                        LINKS
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-8">
        <div class="dashboard-container">
            <div class="row">
                <div class="col">
                    <div class="dashboard-title">DASHBOARD</div>
                </div>
            </div>
            <div class="row credential-row">
                <div class="col">
                    <div>No recent updates</div>
                </div>
                <div class="col"></div>
                <div class="col">
                    @if (Model.Dashboard.ShowNewestPdfTranscript || Model.Dashboard.ShowShareableLinksSection)
                    {
                        <h5 class="dashboard-section-title">Data Highlights</h5>
                        @if (Model.Dashboard.ShowNewestPdfTranscript)
                        {
                            var pdf = Model.Dashboard.NewestPdfTranscript;
                            <div class="highlights-group mt-3">
                                <h6>Latest Transcript</h6>
                                <p class="font-weight-lighter">From @pdf.ClrViewModel.Name issued on @pdf.ClrViewModel.IssuedOn.ToString("d").</p>
                                <div class="text-center">
                                    <button type="button" name="view-pdf-button" data-name="@pdf.EvidenceName" data-clrid="@pdf.ClrId" data-assertionid="@pdf.AssertionId" data-artifactid="@pdf.ArtifactId" class="btn btn-outline-primary btn-lg w-100 " title="DOWNLOAD @pdf.ArtifactName">DOWNLOAD</button>
                                </div>
                            </div>
                        }
                        @if (Model.Dashboard.ShowShareableLinksSection)
                        {
                <div class="highlights-group mt-3">
                    <h6>Shareable Credential</h6>

                    @if (Model.Dashboard.ShowLatestShareableLink)
                    {
                        var link = Model.Dashboard.LatestShareableLink;

                        <div class="highlights-group-button">
                            <a class="btn btn-outline-primary btn-lg w-100" title="View Shareable Credential" href="@Model.GetLinkUrl(link.Id)">VIEW</a>
                        </div>
                    }
                    <div class="highlights-group-button mt-3">
                        <a class="btn btn-outline-primary btn-lg w-100" title="Share Credential" asp-page="/Links/Create">SHARE</a>
                    </div>
                </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-5">
    <div class="col">
        <div class="credentials-container p-5">
            <div class="row justify-content-end">
                <div class="col-4">
                    <h4 class="text-center">Credentials</h4>
                </div>
                <div class="col-4 text-right">
                    <button type="button" class="btn btn-lg btn-outline-primary d-none">CREATE FOLIO</button>
                </div>
            </div>

            <div asp-validation-summary="ModelOnly" class="alert alert-danger mt-2"></div>

            @*<p>
                    <a asp-page="/Sources/Register">Connect to a source</a> |
                    <a asp-page="./Create">Create a collection</a>
                </p>*@

            <p>
                <a class="btn btn-link @(Model.CredentialPackages.Count == 0 ? "disabled" : "")" asp-page="/Links/Index">Manage your shared credentials</a>
            </p>

            @if (Model.CredentialPackages.Count == 0)
            {
                <div class="card text-white bg-info mb-4">
                    <div class="card-body">
                        <div class="card-text">
                            Connect to a source or upload a VC/CLR file you received directly from a publisher.
                        </div>
                    </div>
                </div>}
            else
            {
                foreach (var package in Model.CredentialPackages)
                {
                    await RenderCredentialSection(package);
                }
            }
        </div>
    </div>
</div>

<div class="row mt-5">
    <div class="col">
        <div class="upload-container p-5">
            <div class="card">
                <div class="card-header">Upload</div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        <div class="form-group">
                            <label asp-for="ClrUpload"></label>
                            <input asp-for="ClrUpload" type="file" class="form-control-file" />
                            <span asp-validation-for="ClrUpload" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <button type="submit" asp-page-handler="Upload" class="btn btn-outline-primary btn-lg">Upload CLR</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal-assertion-details" class="modal" role="dialog" style="font-size:13px;">
    <div class="modal-dialog">
        <div class="modal-content" style="padding-bottom:60px;">
            <div class="modal-header" style="border-bottom:none;">
                <span aria-hidden="true" class="remove-button-icon" data-dismiss="modal" style="margin-top:9px;cursor:pointer"></span>

                <h5 class="modal-title"></h5>
                <button type="button" class="btn btn-lg btn-outline-primary" data-dismiss="modal" aria-label="Verify">
                    <span aria-hidden="true">Verify</span>
                </button>
            </div>
            <div class="modal-body">

            </div>
        </div>
    </div>
</div>

@functions {

    List<T> Combine<T>(params List<T>[] lists)
    {
        var list = new List<T>();
        foreach (var l in lists)
            list.AddRange(l);
        return list;
    }

    private async Task RenderCredentialSection(CredentialPackageModel package)
    {
        var clrs = package.TypeId switch
        {
            PackageTypeEnum.VerifiableCredential => Combine(package.VerifiableCredential.Clrs, package.VerifiableCredential.ClrSets.SelectMany(c => c.Clrs).ToList()),
            PackageTypeEnum.ClrSet => package.ClrSet.Clrs,
            PackageTypeEnum.Clr => new List<ClrModel> { { package.Clr } }
        };

        var totalAssertions = clrs.Sum(clr => clr.AssertionsCount);
        <div class="row credential-row mb-3">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <div class="row">
                            <div class="col">
                                @totalAssertions ASSERTIONS
                            </div>
                            <div class="col text-right">
                                ADDED ON @package.CreatedAt.ToLocalTime().ToString("G")
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (package.TypeId == PackageTypeEnum.VerifiableCredential)
                        {
                            foreach (var clr in package.VerifiableCredential.AllClrs)
                            {
                                await RenderClrSection(clr);
                            }
                        }
                        else if (package.TypeId == PackageTypeEnum.ClrSet)
                        {
                            foreach (var clr in package.ClrSet.ClrViewModels)
                            {
                                await RenderClrSection(clr);
                            }
                        }
                        else if (package.TypeId == PackageTypeEnum.Clr)
                        {
                            await RenderClrSection(package.ClrViewModel);
                        }
                    </div>
                </div>
            </div>

        </div> }

    private async Task RenderClrSection(ClrViewModel clr)
    {

        <section class="clr-section">
            <div class="card-section-header cursor">
                <div class="row">
                    <div class="col-sm-6">
                        <h5>
                            <span class="expand-button-icon mr-2"></span> @clr.Name - @clr.Publisher.Name
                        </h5>
                    </div>
                    <div class="col-sm-2">
                        <a class="font-18" asp-page="/Credentials/Display" asp-route-id="@clr.ClrId">
                            Details
                        </a>
                    </div>
                    <div class="col-sm-2 text-right">ISSUED ON</div>
                    <div class="col-sm-2">
                        <b>@clr.IssuedOn.ToString("MM/dd/yyyy", System.Globalization.CultureInfo.CreateSpecificCulture("de-DE"))</b>
                    </div>
                </div>
            </div>
            <div id="clr-@clr.Id" class="card-section-body collapsed">
                @foreach (var assertion in clr.Assertions)
                {
                    <partial name="_AssertionDetails" model="assertion" />
                }
            </div>
        </section> }

    private async Task RenderClrRow(ClrModel clr)
    {
        <tr>
            <td class="align-middle">
                @if (clr.Authorization == null)
                {
                    <img src="~/images/noun_File_1909649.svg" style="height: 1.5em;"
                         title="Uploaded on @clr.RefreshedAt.ToShortDateString()." />
                }
                else
                {
                    <form method="post">
                        <button type="submit" asp-page-handler="Refresh" asp-route-id="@clr.Authorization.Id"
                                class="btn p-0" title="Last retrieved on @clr.RefreshedAt.ToShortDateString(). Click to refresh all CLRs from @clr.Authorization.Source.Name.">
                            <img src="~/images/noun_Data_942487.svg" style="height: 1.5em;" />
                        </button>
                    </form>
                }
            </td>
            <td class="align-middle">@clr.PublisherName</td>
            <td class="align-middle">@clr.IssuedOn.ToShortDateString()</td>
            <td class="align-middle">@clr.Name</td>
            <td class="align-middle text-center">@clr.AssertionsCount</td>
            <td class="align-middle">
                <form method="post">
                    <a asp-page="./Display" asp-route-id="@clr.Id">Display</a> |
                    <a asp-page="./Delete" asp-route-id="@clr.Id">Delete</a> |
                    <input type="hidden" name="id" value="@clr.Id" />
                    <button type="submit" asp-page-handler="Download" class="btn btn-link btn-download p-0 align-baseline">Download</button>
                </form>
            </td>
        </tr>}
}

@section Scripts {
    <script>

        $(".modal-dialog").css("width", "60%");
        $(".card-section-header").on("click", function (event) {
            if (event.target.tagName === 'A') return;
            $(".expand-button-icon", this).toggleClass("collapsed");
            $(this).next(".card-section-body").toggleClass("collapsed");
        });

        $(".assertion-header").on("click", function (c) {

            $(this).parent().next(".assertion-info").toggleClass("collapsed");
            var item = $($(this).children().children("span")[0].firstChild);
            item.toggleClass("fa-angle-right", "fa-angle-down");
            item.toggleClass("fa-angle-down", "fa-angle-right");

        });

        $(".assertion-row").on("click", function () {
            var name = $(this).data("name");
            var i = $(this).parent().parent().next(".assertion-details").html();
            $("#modal-assertion-details").find(".modal-title").html(name);
            $("#modal-assertion-details").find(".modal-body").html(i);
            $("#modal-assertion-details").modal("show");
        });

        $("button[name='view-pdf-button']").on("click", function () {
            var clrId = $(this).data("clrid");
            var name = $(this).data("name");
            var assertionId = $(this).data("assertionid");
            var artifactId = $(this).data("artifactid");
            getPdfDataUrl(clrId, assertionId, artifactId, name);
        })

        function getPdfDataUrl(clrId, assertionId, artifactId, evidenceName) {
            return $.get('/credentials/pdf',
                {
                    clrId: clrId,
                    assertionId: assertionId,
                    artifactId: artifactId,
                    evidenceName: evidenceName
                }
            ).done(function (response) {
                if (response.dataUrl) {
                    exportToView(response.dataUrl);
                }
            })
        }

        function exportToView(dataUrl) {
            const dataWindow = window.open("");
            dataWindow.document.write(
                `<iframe width='100%' height='100%' src='${dataUrl}'></iframe>`);
        }
    </script>
}