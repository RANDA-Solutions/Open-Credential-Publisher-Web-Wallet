@page "{id}"
@using OpenCredentialPublisher.Services.SignalR;

@model OpenCredentialPublisher.Wallet.Pages.Wallets.InvitationModel
@{
    ViewData["Title"] = "Connect your mobile wallet";
    var displayCss = Model.Invitation.HideQrCode ? String.Empty : "display:none;";
}

<div class="row mt-5">
    <div class="col">
        <section class="default-container p-5">
            <h1>Connect your mobile wallet <button type="button" id="refresh_button" class="btn btn-outline-primary btn-lg float-right">Refresh</button></h1>
            <div class="alert alert-primary my-3">
                Open your mobile wallet and scan the QR Code below 
            </div>
            <div id="connection-completed" class="alert alert-info" style="@displayCss">
                The connection to your wallet is complete! Now, please provide a name for this connection in the form below. 
            </div>
            @if (!Model.Invitation.HideQrCode)
            {
                <div class="text-center position-relative" id="qr-code-container">
                    <div id="connecting-banner" class="position-absolute" style="display:none;">
                        Connecting <div id="spinner" class="spinner-grow spinner-grow-sm" role="status"></div>
                    </div>
                    <img class="connection-qr-code" src="data:image/png;base64,@Model.Invitation.QRCodeString" />
                </div>
            }
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <form id="form-wallet-name" method="post" style="@displayCss">
                <div class="input-group mb-3">
                    <div class="input-group-prepend mr-3">
                        <i class="fas fa-wallet fa-2x"></i>
                    </div>
                    <input asp-for="Input.Name" placeholder="Nickname for this connection" class="form-control" />
                    <span asp-validation-for="Input.Name" class="text-danger"></span>
                </div>
                <div class="input-group mb-3">
                    <div class="input-group-prepend mr-3">
                        <span class="blank-icon"></span>
                    </div>
                    <button type="submit" id="btn-login-form" class="btn btn-outline-primary btn-lg">Save</button>
                </div>
            </form>
            <br />
            <a asp-page="./Index">Back to Connected Wallets</a>
        </section>
    </div>
</div>

@section Scripts {
    <script src="~/lib/signalr/signalr.js"></script>
    <script>
        var signalRConnection = null;
        var id = @Model.Invitation.Id;

        function connectSignalR() {
            signalRConnection = new signalR.HubConnectionBuilder()
                .withUrl("@ConnectionStatusHub.Endpoint")
                .withAutomaticReconnect()
                .configureLogging(signalR.LogLevel.Information)
                .build();

            signalRConnection.on('@ConnectionStatusHub.ConnectionStatus', (relationshipId, status, done) => {
                console.log(`SignalR received InvitationReady message (relationshipId: ${relationshipId})`);
                console.log(status);

                if (id == relationshipId && status === "InvitationAccepted") {
                    $("#connecting-banner").show();
                }

                if (id == relationshipId && done) {
                    setTimeout(() => {
                        $("#connecting-banner").hide();
                        $("#connection-completed").show();
                        $("#qr-code-container").hide();
                        $("#form-wallet-name").show();
                    }, 1000);
                }

                
            });

            signalRConnection.onclose(startSignalR);

            // Start the connection.
            startSignalR();
        }


        async function startSignalR() {
            try {
                await signalRConnection.start();

                console.log("SignalR Connected.");
                //signalRConnection.invoke("JoinGroup", requestId)
                //    .catch(err => {
                //        console.log(err);
                //    });
            } catch (err) {
                console.log(err);
                setTimeout(startSignalR, 5000);
            }
        };


        $(function() {
            connectSignalR();
        });

        $("#refresh_button").click(function () {
            window.location.reload();
        })
    </script>
}
